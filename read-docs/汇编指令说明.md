参考文章

1. [Go语言高级编程 - 3.2 计算机结构](https://www.jishuchi.com/read/GO/681?wd=http)


pc是程序指针, 指示当前程序运行到哪了, 指向的是代码区.

sp是代表堆栈指针, 用来指向当前堆栈顶.

```
go tool compile -S main.go >> main.S
```

生成汇编文件 `main.S`

Go汇编为了简化汇编代码的编写，引入了PC、FP、SP、SB四个伪寄存器。四个伪寄存器加其它的通用寄存器就是Go汇编语言对CPU的重新抽象，该抽象的结构也适用于其它非X86类型的体系结构。

在AMD64环境，

- 伪PC寄存器其实是IP指令计数器寄存器的别名。

- 伪FP寄存器对应的是函数的帧指针，一般用来访问函数的参数和返回值。

- 伪SP栈指针对应的是当前函数栈帧的顶部（不包括参数和返回值部分），一般用于**定位局部变量**。伪SP是一个比较特殊的寄存器，因为还存在一个同名的SP真寄存器。

- 真SP寄存器对应的是栈的底部，一般用于定位调用其它函数的参数和返回值。

- SB 全局静态基指针，一般用来声明函数或全局变量


```
               用于声明函数   参数及返回值大小
                   |              | 
 TEXT pkgname·add(SB),NOSPLIT,$64-32
       |        |               |
      包名     函数名         栈帧大小(局部变量+可能需要的额外调用函数的参数空间的总大小，但不包括调用其它函数时的 ret address 的大小)
```

比如函数内部声明两个`int32`变量, 就需要64 bytes栈帧空间, 而返回一个`int32`变量.

$x-y

> 栈帧size, 即x为0时表示该函数没有局部变量, 也不需要调用其他函数, 不需要占用栈空间, 只使用寄存器.

> 栈帧size为0时, 伪SP与真SP指向同一位置.

如果没有本地变量：伪SP=硬件SP+8
如果有本地变量：伪SP=硬件SP+16+本地变量空间大小

------

```
MOVB $1, DI      // 1 byte
MOVW $0x10, BX   // 2 bytes
MOVL $1, DX      // 4 bytes
MOVQ $-10, AX     // 8 bytes
```

赋值语句: 值 -> 寄存器

------

栈空间中的某个函数的结构.

```
                       -----------------                                           
                       current func arg0                                           
                       ----------------- <----------- FP(pseudo FP)                
                        caller ret addr                                            
                       +---------------+                                           
                       | caller BP(*)  |                                           
                       ----------------- <----------- SP(pseudo SP，实际上是当前栈帧的 BP 位置)
                       |   Local Var0  |                                           
                       -----------------                                           
                       |   Local Var1  |                                           
                       -----------------                -                          
                       |   ........    |                                           
                       -----------------                                           
                       |   Local VarN  |                                           
                       -----------------                                           
                       |               |                                           
                       |  temporarily  |                                           
                       |  unused space |                                           
                       |               |                                           
                       -----------------                                           
                       |  call retn    |                                           
                       -----------------                                           
                       |  call ret(n-1)|                                           
                       -----------------                                           
                       |  ..........   |                                           
                       -----------------                                           
                       |  call ret1    |                                           
                       -----------------                                           
                       |  call argn    |                                           
                       -----------------                                           
                       |   .....       |                                           
                       -----------------                                           
                       |  call arg2    |                                           
                       |---------------|                                           
                       |  call arg1    |                                           
                       -----------------   <------------  hardware SP 位置           
                       | return addr   |                                           
                       +---------------+                                           
```

------

栈和栈帧

栈(stack)相对整个系统而言, 调用栈(Call stack)相对某个进程而言, 栈帧(stack frame)则是相对某个函数而言, 调用栈就是正在使用的栈空间, 由多个嵌套调用函数所使用的栈帧组成。

具体来说, Call stack就是指存放某个程序的正在运行的函数的信息的栈。Call stack 由 stack frames 组成, 每个 stack frame 对应于一个未完成运行的函数。

在当今多数计算机体系架构中, 函数的参数传递、局部变量的分配和释放都是通过操纵栈来实现的。栈还用来存储返回值信息、保存寄存器以供恢复调用前处理机状态。每次调用一个函数, 都要为该次调用的函数实例分配栈空间。**为单个函数分配的那部分栈空间就叫做 `stack frame`**, 或者这样说, stack frame 这个说法主要是为了描述函数调用关系的。

Stack frame 组织方式的重要性和作用体现在两个方面:

第一, 它使调用者和被调用者达成某种约定。这个约定定义了函数调用时函数参数的传递方式, 函数返回值的返回方式, 寄存器如何在调用者和被调用者之间进行共享;
第二, 它定义了被调用者如何使用它自己的 stack frame 来完成局部变量的存储和使用。

------

```
                                                                                                                              
                                       caller                                                                                 
                                 +------------------+                                                                         
                                 |                  |                                                                         
       +---------------------->  --------------------                                                                         
       |                         | caller parent BP |                                                                         
       |           BP(pseudo SP) --------------------                                                                         
       |                         |   Local Var0     |                                                                         
       |                         --------------------                                                                         
       |                         |   .......        |                                                                         
       |                         --------------------                                                                         
       |                         |   Local VarN     |                                                                         
       |                         --------------------                                                                         
 caller stack frame              |   callee arg2    |                                                                         
       |                         |------------------|                                                                         
       |                         |   callee arg1    |                                                                         
       |                         |------------------|                                                                         
       |                         |   callee arg0    |                                                                         
       |                         ----------------------------------------------+   FP(virtual register)                       
       |                         |   return addr    |  parent return address   |                                              
       +---------------------->  +------------------+---------------------------    <-------------------------------+         
                                                    |  caller BP               |                                    |         
                                                    |  (caller frame pointer)  |                                    |         
                                     BP(pseudo SP)  ----------------------------                                    |         
                                                    |     Local Var0           |                                    |         
                                                    ----------------------------                                    |         
                                                    |     Local Var1           |                                              
                                                    ----------------------------                            callee stack frame
                                                    |       .....              |                                              
                                                    ----------------------------                                    |         
                                                    |     Local VarN           |                                    |         
                                  SP(Real Register) ----------------------------                                    |         
                                                    |                          |                                    |         
                                                    |                          |                                    |         
                                                    +--------------------------+    <-------------------------------+         
                                                                                                                              
                                                              callee

```